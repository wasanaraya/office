<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบจัดการวัสดุสำนักงาน Deluxe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:'Noto Sans Thai',sans-serif;background:#f7fafd;margin:0;padding:0}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#fff;border-right:1.5px solid #e3e7ee}
    .sidebar-logo{padding:34px 32px 17px;color:#2196f3;font-weight:bold}
    .sidebar-menu{list-style:none;margin:0;padding:0}
    .sidebar-menu a{display:flex;align-items:center;gap:13px;padding:13px 32px;color:#212b36;text-decoration:none}
    .sidebar-menu a.active{background:#e6f2fe;color:#2196f3}
    .main{flex:1 1 auto}
    .topbar{background:#2196f3;color:#fff;padding:22px 36px;font-weight:bold;display:flex;justify-content:space-between}
    .content-area{padding:44px 52px 40px 52px}
    .section-card{background:#fff;border-radius:18px;box-shadow:0 4px 20px rgba(0,0,0,.1);padding:32px 40px;margin-bottom:28px}
    table{width:100%;border-collapse:collapse;font-size:1rem}
    th,td{padding:12px 14px;border-bottom:1.5px solid #eef1f6}
    th{background:#f7fafd;font-weight:700}
    .btn-main{background:#2196f3;color:#fff;border:none;border-radius:8px;padding:10px 32px;cursor:pointer}
    .btn-outline{background:#fff;color:#2196f3;border:1px solid #2196f3;border-radius:8px;padding:10px 24px;cursor:pointer}
    .hidden{display:none}
    input,select,textarea{width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:1rem}
    .modal-custom{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center}
    .modal-dialog{background:#fff;border-radius:12px;padding:24px;max-width:600px;width:90%}
    .form-group{margin-bottom:15px}
    .pagination{display:flex;gap:5px;justify-content:center;margin-top:20px}
    .pagination button{padding:8px 12px;border:1px solid #ddd;background:#fff;cursor:pointer;border-radius:6px}
    .pagination button.active{background:#2196f3;color:#fff}
    .info{background:#e3f2fd;padding:12px;border-radius:6px}
    @media(max-width:768px){.sidebar{width:200px}.content-area{padding:20px}}
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar">
      <div class="sidebar-logo">วัสดุสำนักงาน Deluxe</div>
      <ul class="sidebar-menu">
        <li><a href="#" class="active" onclick="showPage('dashboard')"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li><a href="#" onclick="showPage('materials')"><i class="bi bi-box"></i> วัสดุ</a></li>
        <li><a href="#" onclick="showPage('transactions')"><i class="bi bi-arrow-left-right"></i> รับ-จ่าย</a></li>
        <li><a href="#" onclick="showPage('report')"><i class="bi bi-clipboard-data"></i> รายงาน</a></li>
        <li><a href="#" onclick="showPage('settings')"><i class="bi bi-gear"></i> ตั้งค่า</a></li>
        <li><a href="#" onclick="showPage('budget')"><i class="bi bi-currency-dollar"></i> ขออนุมัติใช้งบ</a></li>
      </ul>
    </nav>
    <div class="main">
      <div class="topbar">
        <span><i class="bi bi-app-indicator"></i> ระบบจัดการวัสดุสำนักงาน</span>
      </div>
      <div class="content-area">
        <!-- Dashboard -->
        <div id="page-dashboard"><div class="page-title">Dashboard</div><div class="section-card" id="dashboardContent">กำลังโหลด...</div></div>
        <!-- Materials -->
        <div id="page-materials" style="display:none"><div class="page-title">รายการวัสดุสำนักงาน</div><div class="section-card"><button class="btn-main" onclick="openAddMaterialModal()"><i class="bi bi-plus-circle"></i> เพิ่มวัสดุ</button><input class="search-input" placeholder="ค้นหา" id="materialSearch" oninput="renderMaterialsTable()"><table id="materialsTable"></table><div id="materialsPagination"></div></div></div>
        <!-- Transactions -->
        <div id="page-transactions" style="display:none"><div class="page-title">ประวัติรับ-จ่ายวัสดุ</div><div class="section-card"><button class="btn-main" style="background:#4caf50" onclick="openAddTransactionModal('in')"><i class="bi bi-arrow-down-circle"></i> รับเข้า</button><button class="btn-main" style="background:#ff9800" onclick="openAddTransactionModal('out')"><i class="bi bi-arrow-up-circle"></i> จ่ายออก</button><input class="search-input" placeholder="ค้นหา" id="transactionSearch" oninput="renderTransactionsTable()"><table id="transactionsTable"></table><div id="transactionsPagination"></div></div></div>
        <!-- Reports -->
        <div id="page-report" style="display:none"><div class="page-title">รายงาน</div><div class="tablist"><button class="tab-btn active" onclick="showReportTab('stock')">สต็อก</button><button class="tab-btn" onclick="showReportTab('lowstock')">ใกล้หมด</button><button class="tab-btn" onclick="showReportTab('expiry')">ยาหมดอายุ</button></div><div class="section-card" id="reportContent"></div></div></div>
        <!-- Settings -->
        <div id="page-settings" style="display:none"><div class="page-title">ตั้งค่าระบบ</div><div class="section-card"><h4>การตั้งค่าทั่วไป</h4><div class="form-group"><label>จำนวนรายการต่อหน้า</label><select class="form-control" id="settingsItemsPerPage"><option>10</option><option>25</option><option>50</option></select></div><div class="form-group"><label>รูปแบบวันที่</label><select class="form-control" id="settingsDateFormat"><option value="th-TH">ไทย</option><option value="en-US">สากล</option></select></div><div style="text-align:right"><button class="btn-main" onclick="saveSettings()">บันทึก</button></div></div></div>
        <!-- Budget Request -->
        <div id="page-budget" style="display:none"><div class="page-title">ขออนุมัติใช้งบประมาณ</div><div class="section-card"><form onsubmit="sendBudgetRequest(event)">
          <label>เลขที่คำขอ</label><input type="text" id="budgetRequestNo" readonly>
          <label>วันที่ขออนุมัติ</label><input type="date" id="budgetRequestDate" required>
          <label>ผู้ขอใช้งบประมาณ</label><input type="text" id="budgetRequester" required>
          <label>รหัสบัญชี</label><select id="budgetAccountCode" onchange="handleBudgetCodeChange()">
            <option value="">-- เลือก --</option>
            <option value="52021100">52021100 - ค่าใช้จ่ายกิจกรรมส่งเสริมค่านิยมร่วมขององค์กร</option>
            <option value="53040100">53040100 - ค่าวัสดุทั่วไป</option>
            <option value="53103600">ค่าจัดประชุม/ชี้แจง</option>
            <option value="53109900">ค่าใช้จ่ายเบ็ดเตล็ด</option>
          </select>
          <label>วงเงินที่ขอใช้ (บาท)</label><input type="number" id="budgetAmount" min="0" step="0.01" required>
          <label>หมายเหตุ</label><textarea id="budgetNote" rows="3"></textarea>
          <div id="budgetMaterialSection" class="hidden">
            <label>รายการวัสดุทั่วไป</label>
            <table><thead><tr><th>รายการ</th><th>จำนวน</th><th>หน่วย</th><th><i class="bi bi-plus-circle add-row-btn" onclick="addBudgetRow()" title="เพิ่มแถว"></i></th></tr></thead><tbody id="budgetMaterialBody"></tbody></table>
          </div>
          <div class="btn-group"><button type="button" class="btn-outline" onclick="resetBudgetForm()">ล้าง</button><button type="submit" class="btn-main">ส่งคำขอ</button></div>
        </form></div></div>
      </div>
    </div>
  </div>

  <script>
    /* ========================= ตั้งค่า Supabase ========================= */
    const supabase = supabase.createClient(
      'https://zubrflyhzsmqngfbjkpg.supabase.co',   // ← แก้
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1YnJmbHloenNtcW5nZmJqa3BnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjA4NjAsImV4cCI6MjA2ODQ5Njg2MH0.SIDLeNDWphs1LxPLO5Mg37oCUB_8eAvfRIz5lCfle8g'                       // ← แก้
    );

    /* ========================= ตัวแปร ========================= */
    let currentPage = 1, currentTransactionPage = 1, itemsPerPage = 10, dateFormat = 'th-TH';
    const accountMap = {
      '52021100':'ค่าใช้จ่ายกิจกรรมส่งเสริมค่านิยมร่วมขององค์กร',
      '53040100':'ค่าวัสดุทั่วไป',
      '53103600':'ค่าจัดประชุม/ชี้แจง',
      '53109900':'ค่าใช้จ่ายเบ็ดเตล็ด'
    };
    const $ = id => document.getElementById(id);

    /* ========================= Navigation ========================= */
    function showPage(page){
      document.querySelectorAll('.sidebar-menu a').forEach(a=>a.classList.remove('active'));
      document.querySelector(`.sidebar-menu a[onclick="showPage('${page}')"]`).classList.add('active');
      document.querySelectorAll('[id^="page-"]').forEach(p=>p.style.display='none');
      $(`page-${page}`).style.display='block';
      if(page==='dashboard')renderDashboard();
      if(page==='materials'){currentPage=1;renderMaterialsTable();}
      if(page==='transactions'){currentTransactionPage=1;renderTransactionsTable();}
      if(page==='report')showReportTab('stock');
      if(page==='settings')loadSettings();
      if(page==='budget')loadBudgetForm();
    }

    /* ========================= CRUD Supabase ========================= */
    async function renderMaterialsTable(){
      const q=$('materialSearch')?.value||'';const {data}=await supabase.from('materials').select('*').ilike('name',`%${q}%`).order('name');if(!data)return;
      const p=Math.ceil(data.length/itemsPerPage),start=(currentPage-1)*itemsPerPage;
      $('materialsTable').innerHTML=`<thead><tr><th>รหัส</th><th>ชื่อ</th><th>ประเภท</th><th>คงเหลือ</th><th>จัดการ</th></tr></thead><tbody>${data.slice(start,start+itemsPerPage).map(m=>`<tr><td>${m.material_code}</td><td>${m.name}</td><td>${m.category}</td><td>${m.current_stock}</td><td><button class="btn-outline" onclick="deleteMaterial('${m.id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('')}</tbody>`;renderPagination('materialsPagination',currentPage,p,pg=>{currentPage=pg;renderMaterialsTable();});
    }
    async function openAddMaterialModal(){
      const name=prompt('ชื่อวัสดุ');if(!name)return;
      await supabase.from('materials').insert([{name,current_stock:0,min_stock:0,price:0}]);
      renderMaterialsTable();
    }
    async function deleteMaterial(id){
      if(!confirm('ลบวัสดุนี้หรือไม่?'))return;
      await supabase.from('materials').delete().eq('id',id);
      renderMaterialsTable();
    }
    async function renderTransactionsTable(){
      const {data}=await supabase.from('transactions').select('*,materials(name)').order('transaction_date',{ascending:false});
      const p=Math.ceil(data.length/itemsPerPage),start=(currentTransactionPage-1)*itemsPerPage;
      $('transactionsTable').innerHTML=`<thead><tr><th>วันที่</th><th>ประเภท</th><th>วัสดุ</th><th>จำนวน</th></tr></thead><tbody>${data.slice(start,start+itemsPerPage).map(t=>`<tr><td>${new Date(t.transaction_date).toLocaleDateString('th-TH')}</td><td>${t.type==='in'?'รับ':'จ่าย'}</td><td>${t.materials.name}</td><td>${t.quantity}</td></tr>`).join('')}</tbody>`;renderPagination('transactionsPagination',currentTransactionPage,p,pg=>{currentTransactionPage=pg;renderTransactionsTable();});
    }
    async function openAddTransactionModal(type){
      const {data:mat}=await supabase.from('materials').select('id,name,current_stock');
      const materialId=prompt('เลือกวัสดุ ID',mat.map(m=>m.id).join(', '));if(!materialId)return;
      const qty=parseInt(prompt('จำนวน'));if(!qty)return;
      await supabase.from('transactions').insert([{material_id:materialId,type,quantity:qty,transaction_date:new Date()}]);
      renderTransactionsTable();
    }
    async function renderDashboard(){
      const {data:mat}=await supabase.from('materials').select();const {data:tx}=await supabase.from('transactions').select();
      const total=mat.length,stock=mat.reduce((a,m)=>a+m.current_stock,0),low=mat.filter(m=>m.current_stock<=m.min_stock).length,trans=tx.length;
      $('dashboardContent').innerHTML=`<div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px"><div class="dashboard-card blue"><div class="icon blue"><i class="bi bi-box-seam"></i> วัสดุทั้งหมด</div><div class="value">${total}</div></div><div class="dashboard-card green"><div class="icon green"><i class="bi bi-stack"></i> คงเหลือรวม</div><div class="value">${stock}</div></div><div class="dashboard-card red"><div class="icon red"><i class="bi bi-exclamation-triangle"></i> ต่ำกว่าขั้นต่ำ</div><div class="value">${low}</div></div><div class="dashboard-card purple"><div class="icon purple"><i class="bi bi-arrow-left-right"></i> รับ-จ่าย</div><div class="value">${trans}</div></div></div>`;
    }
    async function showReportTab(tab){
      const {data}=await supabase.from('materials').select();
      let html='';
      if(tab==='stock'){const total=data.reduce((a,m)=>a+m.current_stock*m.price,0);html=`<table>${data.map(m=>`<tr><td>${m.name}</td><td>${m.current_stock}</td><td>${m.price}</td><td>${m.current_stock*m.price}</td></tr>`).join('')}</table><div style="text-align:right;font-weight:bold">มูลค่าสต็อกรวม: ${total.toLocaleString()} บาท</div>`;}
      if(tab==='lowstock'){const list=data.filter(m=>m.current_stock<=m.min_stock);html=list.length?`<table>${list.map(m=>`<tr><td>${m.name}</td><td>${m.current_stock}/${m.min_stock}</td></tr>`).join('')}</table>`:'<div style="text-align:center;color:#4caf50"><i class="bi bi-check-circle"></i><br>ไม่มีวัสดุต่ำกว่าขั้นต่ำ</div>`;}
      if(tab==='expiry'){const list=data.filter(m=>m.category==='ยา'&&m.expiry_date);html=list.length?`<table>${list.map(m=>`<tr><td>${m.name}</td><td>${new Date(m.expiry_date).toLocaleDateString('th-TH')}</td></tr>`).join('')}</table>`:'<div style="text-align:center;color:#4caf50"><i class="bi bi-check-circle"></i><br>ไม่มียาในสต็อก</div>`;}
      $('reportContent').innerHTML=html;
    }
    async function loadSettings(){
      const {data}=await supabase.from('settings').select().in('key',['itemsPerPage','dateFormat']);
      if(data){data.forEach(d=>{if(d.key==='itemsPerPage')$('settingsItemsPerPage').value=d.value;if(d.key==='dateFormat')$('settingsDateFormat').value=d.value;});}
      itemsPerPage=parseInt($('settingsItemsPerPage').value||10);dateFormat=$('settingsDateFormat').value||'th-TH';
    }
    async function saveSettings(){
      await supabase.from('settings').upsert([{key:'itemsPerPage',value:$('settingsItemsPerPage').value},{key:'dateFormat',value:$('settingsDateFormat').value}]);
      itemsPerPage=parseInt($('settingsItemsPerPage').value);dateFormat=$('settingsDateFormat').value;renderMaterialsTable();renderTransactionsTable();showToast('บันทึกการตั้งค่าแล้ว');
    }
    /* ---------- Budget ---------- */
    function generateBudgetNo(){
      const y=new Date().getFullYear()+543;const key=`budgetNo_${y}`;const current=parseInt(localStorage.getItem(key)||"0",10)+1;localStorage.setItem(key,current);$('budgetRequestNo').value=`ครั้งที่ ${current}/${y}`;
    }
    function handleBudgetCodeChange(){
      $('budgetMaterialSection').classList.toggle('hidden',$('budgetAccountCode').value!=='53040100');
    }
    function addBudgetRow(){
      const tbody=$('budgetMaterialBody');const tr=document.createElement('tr');tr.innerHTML=`<td><input class="material-input" placeholder="เช่น กระดาษ A4" required></td><td><input class="material-input" type="number" min="1" required></td><td><input class="material-input" placeholder="รีม" required></td><td><i class="bi bi-trash del-row-btn" onclick="this.parentNode.parentNode.remove()"></i></td>`;tbody.appendChild(tr);
    }
    function resetBudgetForm(){
      $('budgetAccountCode').value='';$('budgetAmount').value='';$('budgetNote').value='';$('budgetMaterialBody').innerHTML='';$('budgetMaterialSection').classList.add('hidden');
    }
    async function sendBudgetRequest(e){
      e.preventDefault();
      const payload={
        request_no:$('budgetRequestNo').value,
        requester:$('budgetRequester').value,
        request_date:$('budgetRequestDate').value,
        account_code:$('budgetAccountCode').value,
        account_name:accountMap[$('budgetAccountCode').value],
        amount:parseFloat($('budgetAmount').value),
        note:$('budgetNote').value,
        material_list:$('budgetAccountCode').value==='53040100'?Array.from($('budgetMaterialBody').rows).map(r=>{const c=r.querySelectorAll('.material-input');return {item:c[0].value,qty:c[1].value,unit:c[2].value};}):[]
      };
      const {error}=await supabase.from('budget_requests').insert([payload]);
      if(error){alert(error.message);return;}
      await fetch("https://YOUR_PROJECT.supabase.co/functions/v1/sendMail",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({to:'sorawitt@gmail.com',cc:'kimhun645@gmail.com',subject:`ขออนุมัติใช้งบ ${payload.account_name} (${payload.request_no})`,body:`เรียน ผจศ.\n\nเลขที่คำขอ: ${payload.request_no}\nผู้ขอ: ${payload.requester}\nวันที่ขอ: ${payload.request_date}\nวงเงิน: ${payload.amount.toLocaleString()} บาท\n${payload.material_list.length ? 'รายการวัสดุทั่วไป:\n' + payload.material_list.map((m,i)=>`${i+1}. ${m.item} ${m.qty} ${m.unit}`).join('\n') : ''}\n\nหมายเหตุ: ${payload.note}\n\nโปรดคลิกอนุมัติ/ปฏิเสธที่: https://yourdomain.com/approve.html?id=${payload.request_no}`})
      });
      resetBudgetForm();generateBudgetNo();showToast('ส่งคำขอสำเร็จ');
    }

    /* ---------- ตั้งค่าเริ่มต้น ---------- */
    document.addEventListener('DOMContentLoaded',()=>{showPage('dashboard');loadBudgetForm();});
  </script>
</body>
</html>
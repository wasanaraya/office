<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบจัดการวัสดุสำนักงาน Deluxe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts (Noto Sans Thai) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: #f7fafd;
      margin: 0;
      padding: 0;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: #fff;
      border-right: 1.5px solid #e3e7ee;
      display: flex;
      flex-direction: column;
      z-index: 2;
    }

    .sidebar-logo {
      font-weight: bold;
      color: #2196f3;
      font-size: 1.25rem;
      padding: 34px 32px 17px 32px;
      letter-spacing: 1px;
    }

    .sidebar-menu {
      list-style: none;
      margin: 0;
      padding: 0 0 12px 0;
      flex: 1 1 auto;
    }

    .sidebar-menu li {
      margin: 0;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      gap: 13px;
      padding: 13px 32px;
      color: #212b36;
      text-decoration: none;
      font-size: 1.08rem;
      border-left: 4px solid transparent;
      transition: background 0.19s, color 0.19s;
      border-radius: 8px 0 0 8px;
      cursor: pointer;
    }

    .sidebar-menu a.active,
    .sidebar-menu a:hover {
      background: #e6f2fe;
      color: #2196f3;
      border-left: 4px solid #2196f3;
    }

    .sidebar-footer {
      padding: 15px 32px 8px 32px;
      font-size: 0.98rem;
      color: #b3b9c9;
    }

    .main {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      background: #2196f3;
      color: #fff;
      padding: 22px 36px;
      font-size: 1.35rem;
      letter-spacing: 1px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 6px 0 #e6eaf3;
    }

    .topbar .bi {
      font-size: 1.45rem;
    }

    .content-area {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 44px 52px 40px 52px;
      min-height: 0;
    }

    .page-title {
      font-size: 1.45rem;
      font-weight: bold;
      color: #222;
      margin-bottom: 25px;
    }

    .tablist {
      display: flex;
      border-bottom: 2.5px solid #e3e7ee;
      gap: 13px;
      margin-bottom: 32px;
    }

    .tab-btn {
      padding: 12px 32px 11px 32px;
      font-size: 1.08rem;
      background: none;
      border: none;
      border-bottom: 3.5px solid transparent;
      cursor: pointer;
      color: #656f7c;
      transition: all 0.19s;
      border-radius: 7px 7px 0 0;
    }

    .tab-btn.active {
      color: #2196f3;
      border-bottom: 3.5px solid #2196f3;
      font-weight: bold;
      background: #e6f2fe;
    }

    .section-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 20px 0 #e3eaf3;
      padding: 32px 40px 28px 40px;
      margin-bottom: 28px;
    }

    .section-card table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.03rem;
    }

    .section-card th,
    .section-card td {
      padding: 12px 14px;
      border-bottom: 1.5px solid #eef1f6;
      text-align: left;
    }

    .section-card th {
      background: #f7fafd;
      color: #2a2c32;
      font-weight: 700;
    }

    .section-card tr:last-child td {
      border-bottom: none;
    }

    .btn-main {
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 32px;
      font-size: 1.08rem;
      transition: background 0.15s;
      cursor: pointer;
      margin-right: 7px;
    }

    .btn-main:hover {
      background: #176ac4;
    }

    .btn-outline {
      border: 1.7px solid #2196f3;
      background: #fff;
      color: #2196f3;
      border-radius: 8px;
      padding: 10px 24px;
      font-size: 1.08rem;
      margin-right: 7px;
      transition: all 0.19s;
      cursor: pointer;
    }

    .btn-outline:hover {
      background: #e6f2fe;
    }

    .btn-xs {
      font-size: 1.01em;
      padding: 2px 12px 2px 12px;
    }

    .error-msg {
      color: #f44336;
      font-size: 1.08rem;
      margin-top: 9px;
    }

    .badge {
      background: #2196f3;
      color: #fff;
      border-radius: 9px;
      font-size: 1em;
      padding: 2px 10px;
    }

    .table-action-btn {
      border: none;
      background: none;
      color: #2196f3;
      font-size: 1.20em;
      margin-right: 9px;
      cursor: pointer;
    }

    .table-action-btn:hover {
      color: #176ac4;
    }

    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.62);
      z-index: 99;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 2.1em;
      color: #2196f3;
    }

    .modal-custom {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-dialog {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .form-control:focus {
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    .toast-container {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 3000;
    }

    .toast {
      background: #2196f3;
      color: #fff;
      padding: 13px 22px;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px #b1c1d2;
      min-width: 160px;
      max-width: 330px;
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.danger {
      background: #f44336;
    }

    .toast.warning {
      background: #ff9800;
    }

    .pagination {
      display: flex;
      gap: 5px;
      justify-content: center;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 6px;
    }

    .pagination button:hover {
      background: #f5f5f5;
    }

    .pagination button.active {
      background: #2196f3;
      color: #fff;
      border-color: #2196f3;
    }

    .search-input {
      padding: 6px 13px;
      border-radius: 7px;
      border: 1px solid #b2cdf2;
      margin-left: 12px;
      max-width: 210px;
    }

    .dashboard-card {
      padding: 18px 32px;
      border-radius: 15px;
      flex: 1 1 180px;
      min-width: 160px;
    }

    .dashboard-card.blue {
      background: #e6f2fe;
    }

    .dashboard-card.green {
      background: #e8f5e9;
    }

    .dashboard-card.red {
      background: #ffebee;
    }

    .dashboard-card.purple {
      background: #f3e5f5;
    }

    .dashboard-card .icon {
      font-size: 1.05em;
      margin-bottom: 5px;
    }

    .dashboard-card .icon.blue {
      color: #2196f3;
    }

    .dashboard-card .icon.green {
      color: #43a047;
    }

    .dashboard-card .icon.red {
      color: #f44336;
    }

    .dashboard-card .icon.purple {
      color: #7c43bd;
    }

    .dashboard-card .value {
      font-weight: bold;
      font-size: 1.55em;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .bi-spin {
      animation: spin 1s linear infinite;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
      }
      
      .content-area {
        padding: 20px;
      }
      
      .section-card {
        padding: 20px;
      }
    }

    /* Barcode Scanner Styles */
    .scanner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 2px;
      background: #ff0000;
      box-shadow: 0 0 10px #ff0000;
      animation: scan 2s ease-in-out infinite;
    }

    .scanner-frame {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      bottom: 20px;
      border: 2px solid #fff;
      border-radius: 8px;
      pointer-events: none;
    }

    @keyframes scan {
      0%, 100% { transform: translate(-50%, -50%) scaleX(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scaleX(0.8); opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar">
      <div class="sidebar-logo">วัสดุสำนักงาน Deluxe</div>
      <ul class="sidebar-menu">
        <li><a href="#" class="active" onclick="showPage('dashboard')"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li><a href="#" onclick="showPage('materials')"><i class="bi bi-box"></i> วัสดุ</a></li>
        <li><a href="#" onclick="showPage('transactions')"><i class="bi bi-arrow-left-right"></i> รับ-จ่าย</a></li>
        <li><a href="#" onclick="showPage('report')"><i class="bi bi-clipboard-data"></i> รายงาน</a></li>
        <li><a href="#" onclick="showPage('settings')"><i class="bi bi-gear"></i> ตั้งค่า</a></li>
      </ul>
      <div class="sidebar-footer">
        <span>Deluxe ver. 2024</span>
      </div>
    </nav>
    
    <div class="main">
      <div class="topbar">
        <span>
          <i class="bi bi-app-indicator" style="margin-right: 0.5rem;"></i>
          ระบบจัดการวัสดุสำนักงาน
        </span>
        <span>
          <i class="bi bi-person-circle"></i>
        </span>
      </div>
      
      <div class="content-area">
        <!-- Dashboard Page -->
        <div id="page-dashboard">
          <div class="page-title">Dashboard</div>
          <div class="section-card" id="dashboardContent"></div>
        </div>

        <!-- Materials Page -->
        <div id="page-materials" style="display: none;">
          <div class="page-title">รายการวัสดุสำนักงาน</div>
          <div class="section-card">
            <div style="margin-bottom: 15px;">
              <button class="btn-main" onclick="openAddMaterialModal()">
                <i class="bi bi-plus-circle"></i> เพิ่มวัสดุ
              </button>
              <button class="btn-outline" onclick="exportMaterials()">
                <i class="bi bi-download"></i> Export
              </button>
              <label class="btn-outline" style="cursor: pointer;">
                <i class="bi bi-upload"></i> Import
                <input type="file" accept=".xlsx,.xls" style="display: none;" onchange="importMaterials(event)">
              </label>
              <button class="btn-outline" onclick="openBarcodeScanner()">
                <i class="bi bi-qr-code-scan"></i> สแกน
              </button>
              <input class="search-input" placeholder="ค้นหาชื่อ/รหัส/ประเภท" id="materialSearch" oninput="renderMaterialsTable()">
            </div>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>บาร์โค้ด</th>
                    <th>รหัส</th>
                    <th>ชื่อวัสดุ</th>
                    <th>ประเภท</th>
                    <th>คงเหลือ</th>
                    <th>หน่วย</th>
                    <th>ราคาต่อหน่วย</th>
                    <th>วันหมดอายุ</th>
                    <th>ที่เก็บ</th>
                    <th>จัดการ</th>
                  </tr>
                </thead>
                <tbody id="materialsTableBody"></tbody>
              </table>
            </div>
            <div id="materialsPagination" class="pagination"></div>
          </div>
        </div>

        <!-- Transactions Page -->
        <div id="page-transactions" style="display: none;">
          <div class="page-title">ประวัติรับ-จ่ายวัสดุ</div>
          
          <!-- Summary Cards -->
          <div style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;" id="transactionSummary"></div>

          <div class="section-card">
            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
              <button class="btn-main" style="background: #4caf50;" onclick="openAddTransactionModal('in')">
                <i class="bi bi-arrow-down-circle"></i> รับเข้า
              </button>
              <button class="btn-main" style="background: #ff9800;" onclick="openAddTransactionModal('out')">
                <i class="bi bi-arrow-up-circle"></i> จ่ายออก
              </button>
              
              <select class="form-control" style="width: 120px;" id="transactionFilter" onchange="renderTransactionsTable()">
                <option value="all">ทั้งหมด</option>
                <option value="in">รับเข้า</option>
                <option value="out">จ่ายออก</option>
              </select>
              
              <input class="search-input" placeholder="ค้นหาวัสดุ/เลขที่อ้างอิง/หมายเหตุ" id="transactionSearch" oninput="renderTransactionsTable()">
            </div>

            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>วันที่</th>
                    <th>ประเภท</th>
                    <th>วัสดุ</th>
                    <th>จำนวน</th>
                    <th>เลขที่อ้างอิง</th>
                    <th>หมายเหตุ</th>
                    <th>ผู้ดำเนินการ</th>
                    <th>จัดการ</th>
                  </tr>
                </thead>
                <tbody id="transactionsTableBody"></tbody>
              </table>
            </div>
            <div id="transactionsPagination" class="pagination"></div>
          </div>
        </div>

        <!-- Reports Page -->
        <div id="page-report" style="display: none;">
          <div class="page-title">รายงาน</div>
          
          <div class="tablist">
            <button class="tab-btn active" onclick="showReportTab('stock')">รายงานสต็อก</button>
            <button class="tab-btn" onclick="showReportTab('inout')">รายงานการรับ-จ่าย</button>
            <button class="tab-btn" onclick="showReportTab('usage')">รายงานการใช้</button>
            <button class="tab-btn" onclick="showReportTab('lowstock')">วัสดุใกล้หมด</button>
            <button class="tab-btn" onclick="showReportTab('medicine')">ยาหมดอายุ</button>
          </div>

          <div class="section-card" id="reportContent"></div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" style="display: none;">
          <div class="page-title">ตั้งค่าระบบ</div>
          <div class="section-card">
            <h4 style="margin-top: 0;">การตั้งค่าทั่วไป</h4>
            
            <div class="form-group">
              <label>จำนวนรายการต่อหน้า</label>
              <select class="form-control" style="width: 100px;" id="settingsItemsPerPage">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>

            <div class="form-group">
              <label>รูปแบบวันที่</label>
              <select class="form-control" style="width: 200px;" id="settingsDateFormat">
                <option value="th-TH">ไทย (วว/ดด/ปปปป)</option>
                <option value="en-US">สากล (ปปปป-ดด-วว)</option>
              </select>
            </div>

            <div style="margin-top: 20px; text-align: right;">
              <button class="btn-main" onclick="saveSettings()">
                บันทึกการตั้งค่า
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-backdrop" id="loadingSpinner">
    <span>
      <i class="bi bi-arrow-repeat bi-spin" style="display: inline-block;"></i> กำลังโหลด...
    </span>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modal Container -->
  <div id="modalContainer"></div>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = "https://zubrflyhzsmqngfbjkpg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1YnJmbHloenNtcW5nZmJqa3BnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjA4NjAsImV4cCI6MjA2ODQ5Njg2MH0.SIDLeNDWphs1LxPLO5Mg37oCUB_8eAvfRIz5lCfle8g";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Global Variables
    let materials = [];
    let transactions = [];
    let currentPage = 1;
    let currentTransactionPage = 1;
    let itemsPerPage = 10;
    let dateFormat = 'th-TH';
    let currentReportTab = 'stock';

    // Utility Functions
    function showLoading(show = true) {
      document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);
    }

    function showModal(content) {
      const container = document.getElementById('modalContainer');
      const modal = document.createElement('div');
      modal.className = 'modal-custom';
      modal.innerHTML = `<div class="modal-dialog">${content}</div>`;
      container.appendChild(modal);
      
      modal.onclick = (e) => {
        if (e.target === modal) {
          closeModal();
        }
      };
      
      window.currentModal = modal;
    }

    function closeModal() {
      if (window.currentModal) {
        window.currentModal.remove();
        window.currentModal = null;
      }
    }

    function formatThaiDate(dateString, format = 'th-TH') {
      if (!dateString) return '-';
      
      try {
        const date = new Date(dateString);
        
        if (format === 'th-TH') {
          const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          };
          return date.toLocaleDateString('th-TH', options);
        } else {
          return date.toISOString().slice(0, 16).replace('T', ' ');
        }
      } catch {
        return dateString;
      }
    }

    function generateMaterialCode(category, existingMaterials = []) {
      const prefixMap = {
        "กระดาษ": "PAP",
        "เครื่องเขียน": "PEN",
        "เครื่องใช้สำนักงาน": "STP",
        "จัดเก็บเอกสาร": "FLF",
        "ยา": "MED"
      };
      
      const prefix = prefixMap[category] || "MAT";
      
      let maxNumber = 0;
      existingMaterials.forEach(material => {
        if (material.material_code && material.material_code.startsWith(prefix)) {
          const numPart = material.material_code.replace(prefix, '');
          if (/^\d+$/.test(numPart)) {
            const num = parseInt(numPart);
            if (num > maxNumber) maxNumber = num;
          }
        }
      });
      
      return prefix + (maxNumber + 1).toString().padStart(3, '0');
    }

    function generateBarcode() {
      let code = '';
      const chars = '0123456789';
      for (let i = 0; i < 12; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Navigation Functions
    function showPage(page) {
      // Update sidebar active state
      document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
      document.querySelector(`.sidebar-menu a[onclick="showPage('${page}')"]`).classList.add('active');
      
      // Hide all pages
      document.querySelectorAll('[id^="page-"]').forEach(div => div.style.display = 'none');
      
      // Show selected page
      document.getElementById(`page-${page}`).style.display = 'block';
      
      // Load page content
      switch (page) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'materials':
          renderMaterialsTable();
          break;
        case 'transactions':
          renderTransactionsTable();
          renderTransactionSummary();
          break;
        case 'report':
          renderReport();
          break;
        case 'settings':
          loadSettings();
          break;
      }
    }

    // Data Fetching Functions
    async function fetchMaterials() {
      showLoading(true);
      try {
        const { data, error } = await supabase
          .from('materials')
          .select('*')
          .order('name', { ascending: true });
        
        if (error) throw error;
        materials = data || [];
      } catch (error) {
        showToast('ดึงข้อมูลวัสดุผิดพลาด: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    async function fetchTransactions() {
      try {
        const { data, error } = await supabase
          .from('transactions')
          .select(`
            *,
            materials (
              id,
              name,
              category,
              material_code
            )
          `)
          .order('transaction_date', { ascending: false });
        
        if (error) throw error;
        transactions = data || [];
      } catch (error) {
        showToast('ดึงข้อมูลรายการผิดพลาด: ' + error.message, 'danger');
      }
    }

    // Dashboard Functions
    function renderDashboard() {
      const totalMaterials = materials.length;
      const totalStock = materials.reduce((sum, m) => sum + (m.current_stock || 0), 0);
      const lowStockItems = materials.filter(m => 
        (m.current_stock || 0) <= (m.min_stock || 0)
      ).length;
      const totalTransactions = transactions.length;

      // Critical items (less than 20% of minimum stock)
      const criticalItems = materials.filter(m => {
        if (!m.min_stock || m.min_stock <= 0) return false;
        return (m.current_stock || 0) < (m.min_stock * 0.2);
      });

      // Expired medicines
      const expiredMedicines = materials.filter(m => 
        m.category === 'ยา' && m.expiry_date && new Date(m.expiry_date) < new Date()
      );

      // Medicines expiring soon (within 30 days)
      const expiringSoonMedicines = materials.filter(m => 
        m.category === 'ยา' && m.expiry_date && 
        new Date(m.expiry_date) >= new Date() &&
        new Date(m.expiry_date) < new Date(Date.now() + 30*24*60*60*1000)
      );

      // Top used materials
      const materialUsage = new Map();
      transactions.forEach(tx => {
        const material = materials.find(m => m.id === tx.material_id);
        if (material) {
          if (!materialUsage.has(tx.material_id)) {
            materialUsage.set(tx.material_id, { material, totalOut: 0, totalIn: 0 });
          }
          
          const usage = materialUsage.get(tx.material_id);
          if (tx.type === 'out') {
            usage.totalOut += tx.quantity;
          } else {
            usage.totalIn += tx.quantity;
          }
        }
      });

      const topUsedMaterials = Array.from(materialUsage.values())
        .sort((a, b) => b.totalOut - a.totalOut)
        .slice(0, 5);

      // Recent transactions
      const recentTransactions = [...transactions]
        .sort((a, b) => new Date(b.transaction_date).getTime() - new Date(a.transaction_date).getTime())
        .slice(0, 5);

      let html = `
        <div style="display: flex; gap: 22px; flex-wrap: wrap; margin-bottom: 18px;">
          <div class="dashboard-card blue">
            <div class="icon blue">
              <i class="bi bi-box-seam"></i> วัสดุทั้งหมด
            </div>
            <div class="value">${totalMaterials}</div>
          </div>
          
          <div class="dashboard-card green">
            <div class="icon green">
              <i class="bi bi-stack"></i> คงเหลือรวม
            </div>
            <div class="value">${totalStock}</div>
          </div>
          
          <div class="dashboard-card red">
            <div class="icon red">
              <i class="bi bi-exclamation-triangle"></i> ต่ำกว่าขั้นต่ำ
            </div>
            <div class="value">${lowStockItems}</div>
          </div>
          
          <div class="dashboard-card purple">
            <div class="icon purple">
              <i class="bi bi-arrow-left-right"></i> รับ-จ่าย
            </div>
            <div class="value">${totalTransactions}</div>
          </div>
        </div>
      `;

      // Critical items alert
      if (criticalItems.length > 0) {
        html += `
          <div style="margin-top: 30px;">
            <h4 style="color: #f44336; margin-bottom: 15px;">
              <i class="bi bi-exclamation-triangle"></i> วัสดุใกล้หมดวิกฤต
            </h4>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
              ${criticalItems.slice(0, 5).map(item => `
                <span class="badge" style="background: #f44336;">
                  ${item.name} (${item.current_stock}/${item.min_stock})
                </span>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Medicine expiry alerts
      if (expiredMedicines.length > 0 || expiringSoonMedicines.length > 0) {
        html += `
          <div style="margin-top: 30px;">
            <h4 style="color: #f44336; margin-bottom: 15px;">
              <i class="bi bi-exclamation-triangle"></i> แจ้งเตือนยาหมดอายุ
            </h4>
        `;
        
        if (expiredMedicines.length > 0) {
          html += `
            <div style="margin-bottom: 10px;">
              <strong style="color: #f44336;">ยาหมดอายุแล้ว:</strong>
              <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                ${expiredMedicines.slice(0, 5).map(item => `
                  <span class="badge" style="background: #f44336;">
                    ${item.name} (หมดอายุ: ${new Date(item.expiry_date).toLocaleDateString('th-TH')})
                  </span>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        if (expiringSoonMedicines.length > 0) {
          html += `
            <div>
              <strong style="color: #ff9800;">ยาใกล้หมดอายุ (30 วัน):</strong>
              <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                ${expiringSoonMedicines.slice(0, 5).map(item => `
                  <span class="badge" style="background: #ff9800;">
                    ${item.name} (หมดอายุ: ${new Date(item.expiry_date).toLocaleDateString('th-TH')})
                  </span>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        html += '</div>';
      }

      // Top used materials
      if (topUsedMaterials.length > 0) {
        html += `
          <div style="margin-top: 30px;">
            <h4 style="margin-bottom: 15px;">วัสดุที่ใช้มากที่สุด</h4>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>อันดับ</th>
                    <th>ชื่อวัสดุ</th>
                    <th>ประเภท</th>
                    <th>จ่ายออกรวม</th>
                    <th>คงเหลือ</th>
                  </tr>
                </thead>
                <tbody>
                  ${topUsedMaterials.map((item, index) => `
                    <tr>
                      <td>
                        <span class="badge" style="background: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#2196f3'}; color: ${index < 3 ? '#000' : '#fff'};">
                          #${index + 1}
                        </span>
                      </td>
                      <td>${item.material.name}</td>
                      <td>${item.material.category}</td>
                      <td style="color: #f44336; font-weight: bold;">${item.totalOut}</td>
                      <td style="color: ${item.material.current_stock <= item.material.min_stock ? '#f44336' : '#4caf50'}; font-weight: bold;">
                        ${item.material.current_stock}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      // Recent transactions
      if (recentTransactions.length > 0) {
        html += `
          <div style="margin-top: 30px;">
            <h4 style="margin-bottom: 15px;">รายการล่าสุด</h4>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>วันที่</th>
                    <th>ประเภท</th>
                    <th>วัสดุ</th>
                    <th>จำนวน</th>
                    <th>หมายเหตุ</th>
                  </tr>
                </thead>
                <tbody>
                  ${recentTransactions.map(tx => `
                    <tr>
                      <td>${new Date(tx.transaction_date).toLocaleDateString('th-TH')}</td>
                      <td>
                        <span class="badge" style="background: ${tx.type === 'in' ? '#4caf50' : '#ff9800'};">
                          ${tx.type === 'in' ? 'รับ' : 'จ่าย'}
                        </span>
                      </td>
                      <td>${tx.materials?.name || 'ไม่ระบุ'}</td>
                      <td>${tx.quantity}</td>
                      <td>${tx.note || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      document.getElementById('dashboardContent').innerHTML = html;
    }

    // Materials Functions
    function renderMaterialsTable() {
      const searchQuery = document.getElementById('materialSearch')?.value || '';
      const filteredMaterials = materials.filter(material =>
        searchQuery === '' || 
        [material.name, material.material_code, material.category, material.barcode]
          .some(field => field?.toLowerCase().includes(searchQuery.toLowerCase()))
      );

      const totalPages = Math.ceil(filteredMaterials.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedMaterials = filteredMaterials.slice(startIndex, startIndex + itemsPerPage);

      const tbody = document.getElementById('materialsTableBody');
      if (!tbody) return;

      tbody.innerHTML = paginatedMaterials.length > 0 ? paginatedMaterials.map(material => `
        <tr>
          <td>${material.barcode || '-'}</td>
          <td>${material.material_code || '-'}</td>
          <td>${material.name || '-'}</td>
          <td>${material.category || '-'}</td>
          <td style="font-weight: ${material.current_stock <= material.min_stock ? 'bold' : 'normal'}; color: ${material.current_stock <= material.min_stock ? '#f44336' : 'inherit'};">
            ${material.current_stock || 0}
          </td>
          <td>${material.unit || '-'}</td>
          <td>${material.price ? parseFloat(material.price.toString()).toLocaleString('th-TH') : '-'}</td>
          <td style="color: ${material.category === 'ยา' && material.expiry_date ? 
            (new Date(material.expiry_date) < new Date() ? '#f44336' : 
             new Date(material.expiry_date) < new Date(Date.now() + 30*24*60*60*1000) ? '#ff9800' : 'inherit') : 'inherit'};">
            ${material.category === 'ยา' && material.expiry_date ? 
              new Date(material.expiry_date).toLocaleDateString('th-TH') : '-'}
          </td>
          <td>${material.location || '-'}</td>
          <td>
            <button class="table-action-btn" title="แก้ไข" onclick="openEditMaterialModal('${material.id}')">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button class="table-action-btn" title="ลบ" onclick="deleteMaterial('${material.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('') : `<tr><td colspan="10" style="text-align: center; color: #aaa;">ไม่มีข้อมูล</td></tr>`;

      renderPagination('materialsPagination', currentPage, totalPages, (page) => {
        currentPage = page;
        renderMaterialsTable();
      });
    }

    function renderPagination(containerId, current, total, onPageChange) {
      const container = document.getElementById(containerId);
      if (!container || total <= 1) {
        if (container) container.innerHTML = '';
        return;
      }

      let html = '';
      
      if (current > 1) {
        html += `<button onclick="(${onPageChange})(${current - 1})"><i class="bi bi-chevron-left"></i></button>`;
      }
      
      for (let i = 1; i <= total; i++) {
        html += `<button class="${i === current ? 'active' : ''}" onclick="(${onPageChange})(${i})">${i}</button>`;
      }
      
      if (current < total) {
        html += `<button onclick="(${onPageChange})(${current + 1})"><i class="bi bi-chevron-right"></i></button>`;
      }

      container.innerHTML = html;
    }

    function openAddMaterialModal() {
      const categories = ["กระดาษ", "เครื่องเขียน", "เครื่องใช้สำนักงาน", "จัดเก็บเอกสาร", "ยา"];
      
      const content = `
        <h3 style="margin-top: 0; margin-bottom: 20px;">เพิ่มวัสดุใหม่</h3>
        
        <form onsubmit="saveAddMaterial(event)">
          <div class="form-group">
            <label>ชื่อวัสดุ *</label>
            <input type="text" class="form-control" id="matName" required>
          </div>

          <div class="form-group">
            <label>ประเภท *</label>
            <select class="form-control" id="matCategory" onchange="updateMaterialCode()" required>
              <option value="">เลือกประเภท</option>
              ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
          </div>

          <div class="form-group">
            <label>รหัสวัสดุ</label>
            <input type="text" class="form-control" id="matCode">
          </div>

          <div class="form-group">
            <label>บาร์โค้ด</label>
            <div style="display: flex; gap: 10px;">
              <input type="text" class="form-control" id="matBarcode" style="flex: 1;">
              <button type="button" class="btn-outline" onclick="openBarcodeScanner('matBarcode')" style="margin-right: 5px;">
                สแกน
              </button>
              <button type="button" class="btn-outline" onclick="document.getElementById('matBarcode').value = generateBarcode()">
                สร้างอัตโนมัติ
              </button>
            </div>
          </div>

          <div style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;">
              <label>จำนวนเริ่มต้น</label>
              <input type="number" class="form-control" id="matInitStock" value="0" min="0">
            </div>

            <div class="form-group" style="flex: 1;">
              <label>จำนวนขั้นต่ำ</label>
              <input type="number" class="form-control" id="matMinStock" value="0" min="0">
            </div>
          </div>

          <div style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;">
              <label>หน่วย</label>
              <input type="text" class="form-control" id="matUnit" placeholder="ชิ้น, กล่อง, แพ็ค">
            </div>

            <div class="form-group" style="flex: 1;">
              <label>ราคาต่อหน่วย</label>
              <input type="number" class="form-control" id="matPrice" value="0" min="0" step="0.01">
            </div>
          </div>

          <div class="form-group" id="expiryDateGroup" style="display: none;">
            <label>วันหมดอายุ</label>
            <input type="date" class="form-control" id="matExpiryDate">
          </div>

          <div class="form-group">
            <label>ที่เก็บ</label>
            <input type="text" class="form-control" id="matLocation" placeholder="ตู้ A, ชั้น 1, ห้องเก็บของ">
          </div>

          <div class="form-group">
            <label>หมายเหตุ</label>
            <textarea class="form-control" id="matNote" rows="3"></textarea>
          </div>

          <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn-outline" onclick="closeModal()">
              ยกเลิก
            </button>
            <button type="submit" class="btn-main">
              บันทึก
            </button>
          </div>
        </form>
      `;
      
      showModal(content);
    }

    function updateMaterialCode() {
      const category = document.getElementById('matCategory').value;
      const codeField = document.getElementById('matCode');
      const expiryGroup = document.getElementById('expiryDateGroup');
      
      if (category) {
        codeField.value = generateMaterialCode(category, materials);
        
        // Show/hide expiry date field for medicine
        if (category === 'ยา') {
          expiryGroup.style.display = 'block';
        } else {
          expiryGroup.style.display = 'none';
        }
      }
    }

    async function saveAddMaterial(event) {
      event.preventDefault();
      
      const materialData = {
        name: document.getElementById('matName').value.trim(),
        category: document.getElementById('matCategory').value,
        material_code: document.getElementById('matCode').value,
        barcode: document.getElementById('matBarcode').value.trim(),
        initial_stock: parseInt(document.getElementById('matInitStock').value) || 0,
        current_stock: parseInt(document.getElementById('matInitStock').value) || 0,
        min_stock: parseInt(document.getElementById('matMinStock').value) || 0,
        unit: document.getElementById('matUnit').value.trim(),
        price: parseFloat(document.getElementById('matPrice').value) || 0,
        location: document.getElementById('matLocation').value.trim(),
        note: document.getElementById('matNote').value.trim(),
        expiry_date: document.getElementById('matExpiryDate').value || null,
        created_at: new Date().toISOString()
      };

      if (!materialData.name || !materialData.category) {
        showToast('กรุณากรอกชื่อวัสดุและประเภท', 'danger');
        return;
      }

      showLoading(true);
      try {
        const { data, error } = await supabase
          .from('materials')
          .insert([materialData])
          .select();
        
        if (error) throw error;
        
        materials.push(...(data || []));
        showToast('เพิ่มวัสดุสำเร็จ');
        closeModal();
        renderMaterialsTable();
      } catch (error) {
        showToast('บันทึกผิดพลาด: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    function openEditMaterialModal(materialId) {
      const material = materials.find(m => m.id === materialId);
      if (!material) return;

      const categories = ["กระดาษ", "เครื่องเขียน", "เครื่องใช้สำนักงาน", "จัดเก็บเอกสาร", "ยา"];
      
      const content = `
        <h3 style="margin-top: 0; margin-bottom: 20px;">แก้ไขวัสดุ</h3>
        
        <form onsubmit="saveEditMaterial(event, '${materialId}')">
          <div class="form-group">
            <label>ชื่อวัสดุ *</label>
            <input type="text" class="form-control" id="editMatName" value="${material.name || ''}" required>
          </div>

          <div class="form-group">
            <label>ประเภท *</label>
            <select class="form-control" id="editMatCategory" onchange="toggleEditExpiryDate()" required>
              <option value="">เลือกประเภท</option>
              ${categories.map(cat => `<option value="${cat}" ${cat === material.category ? 'selected' : ''}>${cat}</option>`).join('')}
            </select>
          </div>

          <div class="form-group">
            <label>รหัสวัสดุ</label>
            <input type="text" class="form-control" id="editMatCode" value="${material.material_code || ''}">
          </div>

          <div class="form-group">
            <label>บาร์โค้ด</label>
            <input type="text" class="form-control" id="editMatBarcode" value="${material.barcode || ''}">
          </div>

          <div style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;">
              <label>จำนวนปัจจุบัน</label>
              <input type="number" class="form-control" id="editMatCurrentStock" value="${material.current_stock || 0}" min="0">
            </div>

            <div class="form-group" style="flex: 1;">
              <label>จำนวนขั้นต่ำ</label>
              <input type="number" class="form-control" id="editMatMinStock" value="${material.min_stock || 0}" min="0">
            </div>
          </div>

          <div style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;">
              <label>หน่วย</label>
              <input type="text" class="form-control" id="editMatUnit" value="${material.unit || ''}" placeholder="ชิ้น, กล่อง, แพ็ค">
            </div>

            <div class="form-group" style="flex: 1;">
              <label>ราคาต่อหน่วย</label>
              <input type="number" class="form-control" id="editMatPrice" value="${material.price || 0}" min="0" step="0.01">
            </div>
          </div>

          <div class="form-group" id="editExpiryDateGroup" style="display: ${material.category === 'ยา' ? 'block' : 'none'};">
            <label>วันหมดอายุ</label>
            <input type="date" class="form-control" id="editMatExpiryDate" value="${material.expiry_date || ''}">
          </div>

          <div class="form-group">
            <label>ที่เก็บ</label>
            <input type="text" class="form-control" id="editMatLocation" value="${material.location || ''}" placeholder="ตู้ A, ชั้น 1, ห้องเก็บของ">
          </div>

          <div class="form-group">
            <label>หมายเหตุ</label>
            <textarea class="form-control" id="editMatNote" rows="3">${material.note || ''}</textarea>
          </div>

          <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn-outline" onclick="closeModal()">
              ยกเลิก
            </button>
            <button type="submit" class="btn-main">
              บันทึกการเปลี่ยนแปลง
            </button>
          </div>
        </form>
      `;
      
      showModal(content);
    }

    function toggleEditExpiryDate() {
      const category = document.getElementById('editMatCategory').value;
      const expiryGroup = document.getElementById('editExpiryDateGroup');
      
      if (category === 'ยา') {
        expiryGroup.style.display = 'block';
      } else {
        expiryGroup.style.display = 'none';
      }
    }

    async function saveEditMaterial(event, materialId) {
      event.preventDefault();
      
      const materialData = {
        name: document.getElementById('editMatName').value.trim(),
        category: document.getElementById('editMatCategory').value,
        material_code: document.getElementById('editMatCode').value,
        barcode: document.getElementById('editMatBarcode').value.trim(),
        current_stock: parseInt(document.getElementById('editMatCurrentStock').value) || 0,
        min_stock: parseInt(document.getElementById('editMatMinStock').value) || 0,
        unit: document.getElementById('editMatUnit').value.trim(),
        price: parseFloat(document.getElementById('editMatPrice').value) || 0,
        location: document.getElementById('editMatLocation').value.trim(),
        note: document.getElementById('editMatNote').value.trim(),
        expiry_date: document.getElementById('editMatExpiryDate').value || null,
        updated_at: new Date().toISOString()
      };

      if (!materialData.name || !materialData.category) {
        showToast('กรุณากรอกชื่อวัสดุและประเภท', 'danger');
        return;
      }

      showLoading(true);
      try {
        const { data, error } = await supabase
          .from('materials')
          .update(materialData)
          .eq('id', materialId)
          .select();
        
        if (error) throw error;
        
        const index = materials.findIndex(m => m.id === materialId);
        if (index !== -1) {
          materials[index] = { ...materials[index], ...materialData };
        }
        
        showToast('อัปเดตวัสดุสำเร็จ');
        closeModal();
        renderMaterialsTable();
      } catch (error) {
        showToast('อัปเดตผิดพลาด: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    async function deleteMaterial(materialId) {
      if (!confirm('คุณต้องการลบวัสดุนี้หรือไม่?')) return;

      showLoading(true);
      try {
        const { error } = await supabase
          .from('materials')
          .delete()
          .eq('id', materialId);
        
        if (error) throw error;
        
        materials = materials.filter(m => m.id !== materialId);
        showToast('ลบวัสดุสำเร็จ');
        renderMaterialsTable();
      } catch (error) {
        showToast('ลบผิดพลาด: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    // Transaction Functions
    function renderTransactionSummary() {
      const totalIn = transactions
        .filter(tx => tx.type === 'in')
        .reduce((sum, tx) => sum + tx.quantity, 0);

      const totalOut = transactions
        .filter(tx => tx.type === 'out')
        .reduce((sum, tx) => sum + tx.quantity, 0);

      const html = `
        <div class="dashboard-card green">
          <div class="icon green">
            <i class="bi bi-arrow-down-circle"></i> รับเข้าทั้งหมด
          </div>
          <div class="value">${totalIn.toLocaleString()}</div>
        </div>
        
        <div class="dashboard-card red">
          <div class="icon red">
            <i class="bi bi-arrow-up-circle"></i> จ่ายออกทั้งหมด
          </div>
          <div class="value">${totalOut.toLocaleString()}</div>
        </div>
        
        <div class="dashboard-card blue">
          <div class="icon blue">
            <i class="bi bi-list-check"></i> รายการทั้งหมด
          </div>
          <div class="value">${transactions.length}</div>
        </div>
      `;

      document.getElementById('transactionSummary').innerHTML = html;
    }

    function renderTransactionsTable() {
      const searchQuery = document.getElementById('transactionSearch')?.value || '';
      const filterType = document.getElementById('transactionFilter')?.value || 'all';
      
      const filteredTransactions = transactions.filter(tx => {
        const matchesSearch = searchQuery === '' || 
          [tx.materials?.name, tx.reference_number, tx.note, tx.user_name]
            .some(field => field?.toLowerCase().includes(searchQuery.toLowerCase()));
        
        const matchesType = filterType === 'all' || tx.type === filterType;
        
        return matchesSearch && matchesType;
      });

      const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
      const startIndex = (currentTransactionPage - 1) * itemsPerPage;
      const paginatedTransactions = filteredTransactions.slice(startIndex, startIndex + itemsPerPage);

      const tbody = document.getElementById('transactionsTableBody');
      if (!tbody) return;

      tbody.innerHTML = paginatedTransactions.length > 0 ? paginatedTransactions.map(tx => `
        <tr>
          <td>${formatThaiDate(tx.transaction_date, dateFormat)}</td>
          <td>
            <span class="badge" style="background: ${tx.type === 'in' ? '#4caf50' : '#ff9800'};">
              ${tx.type === 'in' ? 'รับเข้า' : 'จ่ายออก'}
            </span>
          </td>
          <td>${tx.materials?.name || 'ไม่ระบุ'}</td>
          <td style="color: ${tx.type === 'in' ? '#4caf50' : '#f44336'}; font-weight: bold;">
            ${tx.type === 'in' ? '+' : '-'}${tx.quantity}
          </td>
          <td>${tx.reference_number || '-'}</td>
          <td>${tx.note || '-'}</td>
          <td>${tx.user_name || 'ไม่ระบุ'}</td>
          <td>
            <button class="table-action-btn" title="ลบ" onclick="deleteTransaction('${tx.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('') : `<tr><td colspan="8" style="text-align: center; color: #aaa;">ไม่มีข้อมูล</td></tr>`;

      renderPagination('transactionsPagination', currentTransactionPage, totalPages, (page) => {
        currentTransactionPage = page;
        renderTransactionsTable();
      });
    }

    function openAddTransactionModal(type = 'in') {
      const content = `
        <h3 style="margin-top: 0; margin-bottom: 20px;">เพิ่มรายการรับ-จ่าย</h3>
        
        <form onsubmit="saveAddTransaction(event)">
          <div class="form-group">
            <label>ประเภทรายการ *</label>
            <select class="form-control" id="txType" style="background-color: ${type === 'in' ? '#e8f5e9' : '#fff3e0'}; color: ${type === 'in' ? '#2e7d32' : '#f57c00'};" required>
              <option value="in" ${type === 'in' ? 'selected' : ''}>รับเข้า</option>
              <option value="out" ${type === 'out' ? 'selected' : ''}>จ่ายออก</option>
            </select>
          </div>

          <div class="form-group">
            <label>วัสดุ *</label>
            <select class="form-control" id="txMaterialId" onchange="updateMaterialInfo()" required>
              <option value="">เลือกวัสดุ</option>
              ${materials.map(material => `
                <option value="${material.id}">
                  ${material.name} (${material.material_code}) - คงเหลือ: ${material.current_stock}
                </option>
              `).join('')}
            </select>
          </div>

          <div id="materialInfo" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; display: none;"></div>

          <div class="form-group">
            <label>จำนวน *</label>
            <input type="number" class="form-control" id="txQuantity" min="1" required>
            <div id="stockWarning" class="error-msg" style="display: none;"></div>
          </div>

          <div class="form-group">
            <label>วันที่ *</label>
            <input type="datetime-local" class="form-control" id="txDate" value="${new Date().toISOString().slice(0, 16)}" required>
          </div>

          <div class="form-group">
            <label>เลขที่อ้างอิง</label>
            <input type="text" class="form-control" id="txReference" placeholder="เลขที่ใบสั่งซื้อ, เลขที่เอกสาร">
          </div>

          <div class="form-group">
            <label>ผู้ดำเนินการ</label>
            <input type="text" class="form-control" id="txUserName" placeholder="ชื่อผู้ดำเนินการ">
          </div>

          <div class="form-group">
            <label>หมายเหตุ</label>
            <textarea class="form-control" id="txNote" rows="3" placeholder="รายละเอียดเพิ่มเติม"></textarea>
          </div>

          <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn-outline" onclick="closeModal()">
              ยกเลิก
            </button>
            <button type="submit" class="btn-main">
              บันทึก
            </button>
          </div>
        </form>
      `;
      
      showModal(content);
    }

    function updateMaterialInfo() {
      const materialId = document.getElementById('txMaterialId').value;
      const material = materials.find(m => m.id === materialId);
      const infoDiv = document.getElementById('materialInfo');
      const quantityInput = document.getElementById('txQuantity');
      const warningDiv = document.getElementById('stockWarning');
      
      if (material) {
        let infoHtml = `
          <strong>ข้อมูลวัสดุ:</strong><br>
          ชื่อ: ${material.name}<br>
          รหัส: ${material.material_code}<br>
        `;
        
        if (material.category === 'ยา' && material.expiry_date) {
          const expiryDate = new Date(material.expiry_date);
          const today = new Date();
          const isExpired = expiryDate < today;
          const isExpiringSoon = expiryDate < new Date(Date.now() + 30*24*60*60*1000) && expiryDate >= today;
          
          infoHtml += `
            วันหมดอายุ: <span style="color: ${isExpired ? '#f44336' : isExpiringSoon ? '#ff9800' : '#4caf50'}; font-weight: bold;">
              ${expiryDate.toLocaleDateString('th-TH')}
              ${isExpired ? ' (หมดอายุแล้ว)' : isExpiringSoon ? ' (ใกล้หมดอายุ)' : ''}
            </span><br>
          `;
        }
        
        infoHtml += `
          คงเหลือปัจจุบัน: <span style="color: ${material.current_stock <= material.min_stock ? '#f44336' : '#4caf50'}; font-weight: bold;">
            ${material.current_stock} ${material.unit}
          </span><br>
          ขั้นต่ำ: ${material.min_stock} ${material.unit}
        `;
        
        infoDiv.innerHTML = infoHtml;
        infoDiv.style.display = 'block';
        
        // Add quantity validation
        quantityInput.oninput = function() {
          const type = document.getElementById('txType').value;
          const quantity = parseInt(this.value) || 0;
          
          if (type === 'out' && quantity > material.current_stock) {
            warningDiv.textContent = `จำนวนที่จ่ายออกเกินสต็อกที่มี (คงเหลือ: ${material.current_stock})`;
            warningDiv.style.display = 'block';
          } else {
            warningDiv.style.display = 'none';
          }
        };
      } else {
        infoDiv.style.display = 'none';
        quantityInput.oninput = null;
        warningDiv.style.display = 'none';
      }
    }

    async function saveAddTransaction(event) {
      event.preventDefault();
      
      const materialId = document.getElementById('txMaterialId').value;
      const type = document.getElementById('txType').value;
      const quantity = parseInt(document.getElementById('txQuantity').value) || 0;
      
      if (!materialId || !quantity || quantity <= 0) {
        showToast('กรุณาเลือกวัสดุและระบุจำนวนที่ถูกต้อง', 'danger');
        return;
      }

      const material = materials.find(m => m.id === materialId);
      if (type === 'out' && material && quantity > material.current_stock) {
        showToast(`จำนวนที่จ่ายออกเกินสต็อกที่มี (คงเหลือ: ${material.current_stock})`, 'danger');
        return;
      }

      const transactionData = {
        material_id: materialId,
        type: type,
        quantity: quantity,
        transaction_date: new Date(document.getElementById('txDate').value).toISOString(),
        reference_number: document.getElementById('txReference').value.trim() || null,
        note: document.getElementById('txNote').value.trim() || null,
        user_name: document.getElementById('txUserName').value.trim() || null
      };

      showLoading(true);
      try {
        const { data, error } = await supabase
          .from('transactions')
          .insert([transactionData])
          .select();
        
        if (error) throw error;
        
        // Update material stock
        if (material) {
          const newStock = type === 'in' 
            ? material.current_stock + quantity
            : material.current_stock - quantity;
          
          const { error: updateError } = await supabase
            .from('materials')
            .update({ current_stock: newStock })
            .eq('id', materialId);
          
          if (updateError) throw updateError;
          
          // Update local data
          material.current_stock = newStock;
        }
        
        // Add to local transactions with material info
        const newTransaction = { ...data[0], materials: material };
        transactions.unshift(newTransaction);
        
        showToast('บันทึกรายการสำเร็จ');
        closeModal();
        renderTransactionsTable();
        renderTransactionSummary();
      } catch (error) {
        showToast('บันทึกผิดพลาด: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    async function deleteTransaction(transactionId) {
      if (!confirm('คุณต้องการลบรายการนี้หรือไม่?')) return;

      const transaction = transactions.find(tx => tx.id === transactionId);
      if (!transaction) {
        showToast('ไม่พบรายการที่ต้องการลบ', 'danger');
        return;
      }

      showLoading(true);
      try {
        const { error } = await supabase
          .from('transactions')
          .delete()
          .eq('id', transactionId);
        
        if (error) throw error;
        
        // Reverse the stock change
        const material = materials.find(m => m.id === transaction.material_id);
        if (material) {
          const newStock = transaction.type === 'in' 
            ? material.current_stock - transaction.quantity
            : material.current_stock + transaction.quantity;
          
          const { error: updateError } = await supabase
            .from('materials')
            .update({ current_stock: Math.max(0, newStock) })
            .eq('id', material.id);
          
          if (updateError) throw updateError;
          
          material.current_stock = Math.max(0, newStock);
        }
        
        transactions = transactions.filter(tx => tx.id !== transactionId);
        showToast('ลบรายการสำเร็จ');
        renderTransactionsTable();
        renderTransactionSummary();
      } catch (error) {
        showToast('ลบผิดพลาด: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    // Report Functions
    function showReportTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[onclick="showReportTab('${tab}')"]`).classList.add('active');
      currentReportTab = tab;
      renderReport();
    }

    function renderReport() {
      let content = '';
      
      switch (currentReportTab) {
        case 'stock':
          content = renderStockReport();
          break;
        case 'inout':
          content = renderInOutReport();
          break;
        case 'usage':
          content = renderUsageReport();
          break;
        case 'lowstock':
          content = renderLowStockReport();
          break;
        case 'medicine':
          content = renderMedicineExpiryReport();
          break;
      }
      
      document.getElementById('reportContent').innerHTML = content;
    }

    function renderStockReport() {
      const reportData = materials.map(material => ({
        ...material,
        value: (material.current_stock || 0) * (material.price || 0)
      }));

      const totalValue = reportData.reduce((sum, item) => sum + item.value, 0);

      return `
        <div style="margin-bottom: 15px;">
          <button class="btn-outline" onclick="exportStockReport()">
            <i class="bi bi-download"></i> Export รายงานสต็อก
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>รหัส</th>
                <th>ชื่อวัสดุ</th>
                <th>ประเภท</th>
                <th>คงเหลือ</th>
                <th>หน่วย</th>
                <th>ราคาต่อหน่วย</th>
                <th>มูลค่ารวม</th>
                <th>วันหมดอายุ</th>
                <th>ที่เก็บ</th>
              </tr>
            </thead>
            <tbody>
              ${reportData.map(item => `
                <tr>
                  <td>${item.material_code}</td>
                  <td>${item.name}</td>
                  <td>${item.category}</td>
                  <td>${item.current_stock}</td>
                  <td>${item.unit}</td>
                  <td>${item.price?.toLocaleString('th-TH')}</td>
                  <td>${item.value.toLocaleString('th-TH')}</td>
                  <td style="color: ${item.category === 'ยา' && item.expiry_date ? 
                    (new Date(item.expiry_date) < new Date() ? '#f44336' : 
                     new Date(item.expiry_date) < new Date(Date.now() + 30*24*60*60*1000) ? '#ff9800' : 'inherit') : 'inherit'};">
                    ${item.category === 'ยา' && item.expiry_date ? 
                      new Date(item.expiry_date).toLocaleDateString('th-TH') : '-'}
                  </td>
                  <td>${item.location}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 20px; text-align: right; font-size: 1.1rem; font-weight: bold;">
          มูลค่าสต็อกรวม: ${totalValue.toLocaleString('th-TH')} บาท
        </div>
      `;
    }

    function renderInOutReport() {
      const reportTransactions = [...transactions]
        .sort((a, b) => new Date(b.transaction_date).getTime() - new Date(a.transaction_date).getTime())
        .slice(0, 50);

      return `
        <div style="margin-bottom: 15px;">
          <button class="btn-outline" onclick="exportTransactions()">
            <i class="bi bi-download"></i> Export รายงานรับ-จ่าย
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>วันที่</th>
                <th>ประเภท</th>
                <th>วัสดุ</th>
                <th>จำนวน</th>
                <th>หมายเหตุ</th>
                <th>ผู้ดำเนินการ</th>
              </tr>
            </thead>
            <tbody>
              ${reportTransactions.map(tx => `
                <tr>
                  <td>${formatThaiDate(tx.transaction_date, dateFormat)}</td>
                  <td>
                    <span style="padding: 4px 8px; border-radius: 4px; color: #fff; background-color: ${tx.type === 'in' ? '#4caf50' : '#ff9800'};">
                      ${tx.type === 'in' ? 'รับ' : 'จ่าย'}
                    </span>
                  </td>
                  <td>${tx.materials?.name || 'ไม่ระบุ'}</td>
                  <td>${tx.quantity}</td>
                  <td>${tx.note || '-'}</td>
                  <td>${tx.user_name || 'ไม่ระบุ'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderUsageReport() {
      const usageMap = new Map();
      
      transactions.forEach(tx => {
        const materialId = tx.material_id;
        const material = materials.find(m => m.id === materialId);
        
        if (material) {
          if (!usageMap.has(materialId)) {
            usageMap.set(materialId, { material, totalOut: 0, totalIn: 0 });
          }
          
          const usage = usageMap.get(materialId);
          if (tx.type === 'out') {
            usage.totalOut += tx.quantity;
          } else {
            usage.totalIn += tx.quantity;
          }
        }
      });

      const usageReport = Array.from(usageMap.values())
        .sort((a, b) => b.totalOut - a.totalOut);

      return `
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>อันดับ</th>
                <th>ชื่อวัสดุ</th>
                <th>ประเภท</th>
                <th>รับเข้าทั้งหมด</th>
                <th>จ่ายออกทั้งหมด</th>
                <th>คงเหลือ</th>
                <th>อัตราการใช้</th>
              </tr>
            </thead>
            <tbody>
              ${usageReport.map((item, index) => `
                <tr>
                  <td>${index + 1}</td>
                  <td>${item.material.name}</td>
                  <td>${item.material.category}</td>
                  <td style="color: #4caf50;">${item.totalIn}</td>
                  <td style="color: #f44336;">${item.totalOut}</td>
                  <td>${item.material.current_stock}</td>
                  <td>
                    ${item.totalIn > 0 ? 
                      `${((item.totalOut / item.totalIn) * 100).toFixed(1)}%` : 
                      'N/A'
                    }
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderLowStockReport() {
      const lowStockReport = materials.filter(material => 
        (material.current_stock || 0) <= (material.min_stock || 0)
      );

      if (lowStockReport.length === 0) {
        return `
          <div style="text-align: center; padding: 40px; color: #4caf50;">
            <i class="bi bi-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <div>ไม่มีวัสดุที่ต่ำกว่าระดับขั้นต่ำ</div>
          </div>
        `;
      }

      return `
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>ระดับ</th>
                <th>ชื่อวัสดุ</th>
                <th>ประเภท</th>
                <th>คงเหลือ</th>
                <th>ขั้นต่ำ</th>
                <th>ต้องเติม</th>
                <th>ที่เก็บ</th>
              </tr>
            </thead>
            <tbody>
              ${lowStockReport.map(item => {
                const percentage = item.min_stock > 0 ? (item.current_stock / item.min_stock) * 100 : 0;
                const level = percentage === 0 ? 'หมด' : percentage < 20 ? 'วิกฤต' : 'ต่ำ';
                const levelColor = percentage === 0 ? '#000' : percentage < 20 ? '#f44336' : '#ff9800';
                
                return `
                  <tr>
                    <td>
                      <span style="color: ${levelColor}; font-weight: bold; padding: 2px 6px; border-radius: 4px; background-color: ${levelColor}20;">
                        ${level}
                      </span>
                    </td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td style="color: ${levelColor}; font-weight: bold;">${item.current_stock}</td>
                    <td>${item.min_stock}</td>
                    <td>${Math.max(0, item.min_stock - item.current_stock)}</td>
                    <td>${item.location || '-'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderMedicineExpiryReport() {
      const medicineExpiryReport = materials
        .filter(m => m.category === 'ยา' && m.expiry_date)
        .map(m => ({
          ...m,
          daysToExpiry: Math.ceil((new Date(m.expiry_date).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)),
          status: new Date(m.expiry_date) < new Date() ? 'expired' : 
                  new Date(m.expiry_date) < new Date(Date.now() + 30*24*60*60*1000) ? 'expiring' : 'good'
        }))
        .sort((a, b) => a.daysToExpiry - b.daysToExpiry);

      if (medicineExpiryReport.length === 0) {
        return `
          <div style="text-align: center; padding: 40px; color: #4caf50;">
            <i class="bi bi-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <div>ไม่มียาในระบบ</div>
          </div>
        `;
      }

      return `
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>สถานะ</th>
                <th>ชื่อยา</th>
                <th>รหัส</th>
                <th>คงเหลือ</th>
                <th>วันหมดอายุ</th>
                <th>จำนวนวันที่เหลือ</th>
                <th>ที่เก็บ</th>
              </tr>
            </thead>
            <tbody>
              ${medicineExpiryReport.map(item => {
                const statusColor = item.status === 'expired' ? '#f44336' : 
                                   item.status === 'expiring' ? '#ff9800' : '#4caf50';
                const statusText = item.status === 'expired' ? 'หมดอายุ' : 
                                  item.status === 'expiring' ? 'ใกล้หมดอายุ' : 'ปกติ';
                
                return `
                  <tr>
                    <td>
                      <span style="color: ${statusColor}; font-weight: bold; padding: 2px 6px; border-radius: 4px; background-color: ${statusColor}20;">
                        ${statusText}
                      </span>
                    </td>
                    <td>${item.name}</td>
                    <td>${item.material_code}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${item.current_stock}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">
                      ${new Date(item.expiry_date).toLocaleDateString('th-TH')}
                    </td>
                    <td style="color: ${statusColor}; font-weight: bold;">
                      ${item.daysToExpiry < 0 ? `เกิน ${Math.abs(item.daysToExpiry)} วัน` : `${item.daysToExpiry} วัน`}
                    </td>
                    <td>${item.location || '-'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Settings Functions
    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('office_material_settings') || '{}');
      itemsPerPage = settings.itemsPerPage || 10;
      dateFormat = settings.dateFormat || 'th-TH';
      
      document.getElementById('settingsItemsPerPage').value = itemsPerPage;
      document.getElementById('settingsDateFormat').value = dateFormat;
    }

    function saveSettings() {
      const settings = {
        itemsPerPage: parseInt(document.getElementById('settingsItemsPerPage').value),
        dateFormat: document.getElementById('settingsDateFormat').value
      };
      
      localStorage.setItem('office_material_settings', JSON.stringify(settings));
      itemsPerPage = settings.itemsPerPage;
      dateFormat = settings.dateFormat;
      
      showToast('บันทึกการตั้งค่าเรียบร้อย');
      
      // Refresh current page
      const currentPageElement = document.querySelector('.sidebar-menu a.active');
      if (currentPageElement) {
        const page = currentPageElement.getAttribute('onclick').match(/'([^']+)'/)[1];
        showPage(page);
      }
    }

    // Import/Export Functions
    function exportMaterials() {
      const exportData = materials.map(material => ({
        'รหัสวัสดุ': material.material_code || '',
        'บาร์โค้ด': material.barcode || '',
        'ชื่อวัสดุ': material.name || '',
        'ประเภท': material.category || '',
        'จำนวนเริ่มต้น': material.initial_stock || 0,
        'จำนวนปัจจุบัน': material.current_stock || 0,
        'จำนวนขั้นต่ำ': material.min_stock || 0,
        'หน่วย': material.unit || '',
        'ราคาต่อหน่วย': material.price || 0,
        'ที่เก็บ': material.location || '',
        'หมายเหตุ': material.note || '',
        'วันหมดอายุ': material.category === 'ยา' && material.expiry_date ? 
          new Date(material.expiry_date).toLocaleDateString('th-TH') : '',
        'วันที่สร้าง': material.created_at ? new Date(material.created_at).toLocaleDateString('th-TH') : ''
      }));

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'วัสดุสำนักงาน');
      
      const fileName = `วัสดุสำนักงาน_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
      XLSX.writeFile(workbook, fileName);
    }

    function exportTransactions() {
      const exportData = transactions.map(tx => ({
        'วันที่': tx.transaction_date ? new Date(tx.transaction_date).toLocaleDateString('th-TH') : '',
        'เวลา': tx.transaction_date ? new Date(tx.transaction_date).toLocaleTimeString('th-TH') : '',
        'ประเภท': tx.type === 'in' ? 'รับเข้า' : 'จ่ายออก',
        'ชื่อวัสดุ': tx.materials?.name || '',
        'รหัสวัสดุ': tx.materials?.material_code || '',
        'จำนวน': tx.quantity || 0,
        'หน่วย': tx.materials?.unit || '',
        'เลขที่อ้างอิง': tx.reference_number || '',
        'ผู้ดำเนินการ': tx.user_name || '',
        'หมายเหตุ': tx.note || ''
      }));

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'รายการรับ-จ่าย');
      
      const fileName = `รายการรับ-จ่าย_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
      XLSX.writeFile(workbook, fileName);
    }

    function exportStockReport() {
      const reportData = materials.map(material => {
        const value = (material.current_stock || 0) * (material.price || 0);
        const status = (material.current_stock || 0) <= (material.min_stock || 0) ? 'ต่ำกว่าขั้นต่ำ' : 'ปกติ';
        
        return {
          'รหัสวัสดุ': material.material_code || '',
          'ชื่อวัสดุ': material.name || '',
          'ประเภท': material.category || '',
          'คงเหลือ': material.current_stock || 0,
          'ขั้นต่ำ': material.min_stock || 0,
          'หน่วย': material.unit || '',
          'ราคาต่อหน่วย': material.price || 0,
          'มูลค่ารวม': value,
          'สถานะ': status,
          'วันหมดอายุ': material.category === 'ยา' && material.expiry_date ? 
            new Date(material.expiry_date).toLocaleDateString('th-TH') : '',
          'ที่เก็บ': material.location || ''
        };
      });

      const worksheet = XLSX.utils.json_to_sheet(reportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'รายงานสต็อก');
      
      const fileName = `รายงานสต็อก_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
      XLSX.writeFile(workbook, fileName);
    }

    async function importMaterials(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        const importedMaterials = jsonData.map(row => ({
          material_code: row['รหัสวัสดุ'] || '',
          barcode: row['บาร์โค้ด'] || '',
          name: row['ชื่อวัสดุ'] || '',
          category: row['ประเภท'] || '',
          initial_stock: parseInt(row['จำนวนเริ่มต้น']) || 0,
          current_stock: parseInt(row['จำนวนปัจจุบัน']) || 0,
          min_stock: parseInt(row['จำนวนขั้นต่ำ']) || 0,
          unit: row['หน่วย'] || '',
          price: parseFloat(row['ราคาต่อหน่วย']) || 0,
          location: row['ที่เก็บ'] || '',
          note: row['หมายเหตุ'] || '',
          expiry_date: row['วันหมดอายุ'] ? new Date(row['วันหมดอายุ']).toISOString().split('T')[0] : null,
          created_at: new Date().toISOString()
        }));

        showLoading(true);
        
        for (const materialData of importedMaterials) {
          if (materialData.name && materialData.category) {
            const { data, error } = await supabase
              .from('materials')
              .insert([materialData])
              .select();
            
            if (error) throw error;
            materials.push(...(data || []));
          }
        }
        
        showToast(`นำเข้าข้อมูลสำเร็จ ${importedMaterials.length} รายการ`);
        renderMaterialsTable();
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message, 'danger');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    }

    // Barcode Scanner Functions
    function openBarcodeScanner(targetInputId = null) {
      const content = `
        <div style="text-align: center;">
          <h3 style="margin-top: 0; margin-bottom: 20px;">สแกนบาร์โค้ด</h3>
          
          <div id="scannerContainer">
            <div style="position: relative; width: 100%; max-width: 400px; margin: 0 auto 20px; background: #000; border-radius: 8px; overflow: hidden;">
              <video id="scannerVideo" autoplay playsinline style="width: 100%; height: 300px; object-fit: cover;"></video>
              <div class="scanner-overlay"></div>
              <div class="scanner-frame"></div>
            </div>
            
            <p style="color: #666; margin-bottom: 20px;">
              วางบาร์โค้ดให้อยู่ในกรอบและรอการสแกน
            </p>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="btn-outline" onclick="manualBarcodeInput('${targetInputId}')">
                ใส่ด้วยตนเอง
              </button>
              <button class="btn-main" onclick="closeModal()">
                ปิด
              </button>
            </div>
          </div>
          
          <div id="scannerError" style="display: none;">
            <div class="error-msg" style="margin-bottom: 20px;">
              ไม่สามารถเข้าถึงกล้องได้ กรุณาอนุญาตการใช้งานกล้อง
            </div>
            <button class="btn-main" onclick="manualBarcodeInput('${targetInputId}')">
              ใส่บาร์โค้ดด้วยตนเอง
            </button>
          </div>
        </div>
      `;
      
      showModal(content);
      
      // Try to start camera
      startBarcodeScanner(targetInputId);
    }

    async function startBarcodeScanner(targetInputId) {
      try {
        const video = document.getElementById('scannerVideo');
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        video.srcObject = stream;
        
        // Simple barcode detection simulation
        // In a real implementation, you would use a library like QuaggaJS or ZXing
        video.onclick = () => {
          const mockBarcode = generateBarcode();
          handleBarcodeScanned(mockBarcode, targetInputId);
        };
        
      } catch (error) {
        document.getElementById('scannerContainer').style.display = 'none';
        document.getElementById('scannerError').style.display = 'block';
      }
    }

    function handleBarcodeScanned(barcode, targetInputId) {
      if (targetInputId) {
        // Set barcode to specific input field
        const input = document.getElementById(targetInputId);
        if (input) {
          input.value = barcode;
        }
      } else {
        // Search for material with this barcode
        const searchInput = document.getElementById('materialSearch');
        if (searchInput) {
          searchInput.value = barcode;
          currentPage = 1;
          renderMaterialsTable();
        }
      }
      
      closeModal();
      showToast('สแกนบาร์โค้ดสำเร็จ');
    }

    function manualBarcodeInput(targetInputId) {
      const barcode = prompt('กรุณาใส่บาร์โค้ดด้วยตนเอง:');
      if (barcode && barcode.trim()) {
        handleBarcodeScanned(barcode.trim(), targetInputId);
      }
    }

    // Initialize Application
    async function initializeApp() {
      showLoading(true);
      
      try {
        await fetchMaterials();
        await fetchTransactions();
        loadSettings();
        renderDashboard();
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    // Start the application when page loads
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>